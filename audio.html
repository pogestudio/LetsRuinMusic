<!DOCTYPE HTML>
<html xmlns = "http://www.w3.org/1999/xhtml">
<head>
 <meta http-equiv="content-type" content="text/html; charset=utf-8" />
 <!-- midi.js package -->
 <script src="./js/MIDI/AudioDetect.js" type="text/javascript"></script>
 <script src="./js/MIDI/LoadPlugin.js" type="text/javascript"></script>
 <script src="./js/MIDI/Plugin.js" type="text/javascript"></script>
 <script src="./js/MIDI/Player.js" type="text/javascript"></script>
 <script src="./js/Window/DOMLoader.XMLHttp.js" type="text/javascript"></script>
 <script src="./js/Window/DOMLoader.script.js" type="text/javascript"></script>
 
  <script src="./js/Window/Event.js" type="text/javascript"></script>
 <!-- extras -->
 <script src="./inc/Base64.js" type="text/javascript"></script>
 <script src="./inc/base64binary.js" type="text/javascript"></script> 
</head>
<body onload="updateSound()">


<script>


window.onload(updateSound());
var cells = {};

var tones = [
	45,47,48,50,52,53,55,
	57,59,60,62,64,65,67,
	69,71,72,74,76,77,79
];


/****************
* REAL FUNCTIONS*
****************/
var xpos = 0;

function updateSound(){
	alert("update sound");
	setInterval(function(){updateSoundY()}, 300);
}

function updateSoundY(){
	alert("update sound y");	
	var x = 16;
	var y = 16;

	for(var i = y; i < 32; i++){
		// Play tone
		if(model.getCellLocal(x+xpos,y) == 1){
			//TODO: Play tone with correct note
			var note = tones[y % tones.length];
			playTone(note,127,0)
		}	
	}
}

function playTone(note, velocity, delay)
{
	 MIDI.noteOn(0, note, velocity, delay);
	 MIDI.noteOff(0, note, delay + 2);
}

function playInstTone(note, velocity, delay, instr)
{
	MIDI.programChange(0, instr);
	MIDI.noteOn(0, note, velocity, delay);
	MIDI.noteOff(0, note, delay + 2);
}


/************
* Test stuff*
************/
function d_playTone(note, velocity, delay, id){
	console.log("Touch Cell");
	changeColor(id)
	if(document.getElementById(id).style.color == "red"){
		clearInterval(cells[id]);
		console.log("Remove music from cell");
	}
	else{
		playTone(note, velocity, delay);
		// this id will be used to clear the interval		
		cells[id] = setInterval(function(){playTone(note, velocity, delay)}, 3000);
		console.log("Add music to cell");
	}
}

function changeColor(id){
	if(document.getElementById(id).style.color != "green")
		document.getElementById(id).style.color="green";
	else
		document.getElementById(id).style.color="red";
}
</script>

<!--MIDI-->
<script type="text/javascript">

//TODO: Dictionary with instruments and their programChange (General_MIDI)

window.onload = function () {
	loadInstruments();
}

function loadInstruments()
{
	MIDI.loadPlugin({
		soundfontUrl: "./soundfont/",
		instrument: "acoustic_grand_piano",
		callback: function() {
			var delay = 0; // play one note every quarter second
			var note = 50; // the MIDI note
			var velocity = 127; // how hard the note hits
			// MIDI.programChange(0,73);
			// play the note
			MIDI.setVolume(0, 127);
	        	//MIDI.noteOn(0, note, velocity, delay) // Play middle C on Channel 0
			//MIDI.noteOff(0, note, delay + 2);
		}
	});
}



</script>
</body>
</html>
